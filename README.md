# Vista AI News Magazine

این مخزن نسخهٔ عملیاتی «مجلهٔ خبری هوش مصنوعی ویستا» است که شامل صفحهٔ اصلی چندزبانه، صفحات جزئیات خبر، API جست‌وجو، RSS، Sitemap پویا، پایپلاین جمع‌آوری و ترجمهٔ خبر و همچنین پنل مدیریت با احراز هویت Supabase و صف بازبینی است. ساختار پروژه بر پایهٔ Next.js 14، Prisma و Supabase Auth پیاده‌سازی شده و از صف `pg-boss` برای زمان‌بندی کران‌ها استفاده می‌کند.

## ساختار پروژه

```
root
├─ src/app/             # App Router و صفحات محلی‌سازی‌شده
├─ src/components/      # کامپوننت‌های UI (در آینده)
├─ src/lib/             # ماژول‌های کمکی (DB، i18n، env)
├─ prisma/              # schema.prisma و seed.ts
├─ public/              # دارایی‌های استاتیک (در آینده)
├─ .husky/              # هوک‌های Git
├─ package.json         # اسکریپت‌ها و وابستگی‌ها (pnpm)
└─ tailwind.config.ts   # پیکربندی TailwindCSS
```

## پیش‌نیازها

- Node.js 18 یا جدیدتر
- pnpm 8 یا جدیدتر (در فایل `package.json` به نسخهٔ توصیه‌شده اشاره شده است)
- پایگاه‌دادهٔ Postgres در دسترس

## راه‌اندازی محلی

```bash
pnpm install
pnpm prisma migrate dev --name init
pnpm prisma db seed
pnpm dev
```

پس از اجرای دستورات فوق برنامه روی آدرس `http://localhost:3000` در دسترس است. مسیر `/fa` نسخهٔ فارسی و `/en` نسخهٔ انگلیسی را نمایش می‌دهد. صفحهٔ اصلی شامل قهرمان، کارت خبرها، دسته‌های پرطرفدار و لینک به صفحات «درباره» و «تماس» است.

### جمع‌آوری و ترجمهٔ خودکار

برای اجرای دستی پایپلاین جمع‌آوری خبر می‌توانید آن را مستقیماً صدا بزنید یا از صف استفاده کنید:

```bash
# اجرای یک‌باره (برای دیباگ)
pnpm ts-node src/jobs/index.ts

# راه‌اندازی Worker صف (کران‌ها در پس‌زمینه)
pnpm queue:worker
```

و یا از مسیر API محافظت‌شده استفاده کنید که درخواست را در صف `pg-boss` قرار می‌دهد:

```bash
curl -X POST \
  -H "Authorization: Bearer $SUPABASE_SERVICE_ROLE_KEY" \
  http://localhost:3000/api/ingest/trigger
```

در صورت تعریف متغیر `LT_URL` (سرویس LibreTranslate یا معادل آن) متن‌های انگلیسی به‌صورت خودکار به فارسی ترجمه و در جدول `TranslationCache` ذخیره می‌شود. فراخوانی‌های تکراری به کمک کش بانک اطلاعاتی انجام نمی‌شوند.

## اسکریپت Seed

اجرای `pnpm prisma db seed` یک کاربر مدیر (`admin@vista-ai.ir`) و یک کاربر ویراستار (`editor@vista-ai.ir`) با شناسهٔ Supabase از پیش تعیین‌شده ایجاد می‌کند و دسته‌بندی‌ها، برچسب‌ها و چند منبع خبری allowlist را مقداردهی اولیه می‌نماید. پس از ایجاد کاربر در Supabase، شناسهٔ `auth.users.id` را با مقدارهای درج‌شده در Seed همسان‌سازی یا رکورد جدیدی ایجاد کنید تا نقش‌ها به درستی اعمال شوند.

## امکانات فعلی

- **صفحات چندزبانه:** مسیر `/[locale]` با `next-intl` پیاده‌سازی شده و ناوبری، هدر/فوتر، قهرمان صفحهٔ اصلی و محتوای صفحات «تماس» و «درباره» را بر اساس زبان تنظیم می‌کند.
- **جزئیات خبر:** مسیر `/[locale]/news/[slug]` متادیتای سئو، JSON-LD و لیست اخبار مرتبط را رندر می‌کند.
- **پایپلاین جمع‌آوری:** فایل `src/jobs/fetch-news.ts` اخبار را از RSS Allowlist خوانده، با `metascraper` نرمال‌سازی و تمیز می‌کند. ماژول `src/jobs/index.ts` آن‌ها را در پایگاه‌داده ذخیره کرده و با قواعد ساده دسته/برچسب می‌زند.
- **ترجمهٔ کش‌شونده:** ماژول `src/lib/translation/provider.ts` در صورت تنظیم LibreTranslate متون انگلیسی را به فارسی ترجمه و در جدول `TranslationCache` ذخیره می‌کند.
- **پنل مدیریت:** مسیر `/admin` با احراز هویت Supabase محافظت شده و شامل صف بازبینی، ویرایشگر محتوای دو زبانه (TipTap) و امکان تغییر وضعیت خبر است.
- **صف زمان‌بندی:** `pg-boss` برای صف‌آوری کران‌های جمع‌آوری و بازسازی کش استفاده می‌شود و Worker اختصاصی (`pnpm queue:worker`) دارد.
- **خروجی‌های سئو:** `src/app/rss.xml/route.ts`، `src/app/sitemap.ts` و `src/app/robots.txt/route.ts` به صورت پویا از داده‌های منتشرشده تولید می‌شوند.
- **جست‌وجوی زنده:** اندپوینت `GET /api/search` نتایج را بر اساس زبان و عبارت جست‌وجو برمی‌گرداند.
- **تست‌ها:** با `vitest` برای طبقه‌بندی (واحد) و ترجمه (End-to-End با کش) پوشش اولیه ارائه شده است.

## مجوز

کد پروژه تحت مجوز اختصاصی شرکت شبکه هوشمند ابتکار ویستا توسعه می‌یابد؛ برای استفادهٔ مجدد حتماً هماهنگ شود.

## تست‌ها

برای اجرای تست‌های واحد یا پایان‌به‌پایان:

```bash
pnpm test        # اجرای همه تست‌ها
pnpm test:unit   # فقط تست‌های واحد
pnpm test:e2e    # فقط تست‌های یکپارچه ترجمه
```

